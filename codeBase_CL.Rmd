---
title: "Obesity Comorbidity Analysis"
author: "Chloe Li"
date: "11/22/2016"
output: 
  html_notebook:
    toc: true
    theme: united
    highlight: kate
    toc_float:
      collapsed: false
      smooth_scroll: false
---

# Introduction

  This report documents data analytics process for obesity comorbidity analysis on data retrieved from NCBI. This is an assignment from Brown University's the CIS Data Science Practice for assessing Chloe Li's technical skills.
  
  *NOTE: Select **Hide Code** to hide all R codes.*

  The objective of tis assignment is to conduct a comorbidity analysis for obesity using NCBI's PubMed database. The data was selected based on a date range of __2000 to 2012__, with a major MeSH descriptor of __"obesity"__ and semantic types of __"Disease or Syndrome"__.


```{r prep, echo=TRUE, message=FALSE, warning=FALSE}
#preparation

#clear environment if needed
rm(list = ls())

#set working directory
setwd('~/Documents/Dev_dataScienceProjects/BrownUniv/')

#load function
source('./PubmedXML_Dict_Fun.R')


#install/reuqire libraries
if (!'pacman' %in% installed.packages()){
  install.packages('pacman')
}

pacman::p_load("ggplot2","dplyr", "rentrez","knitr","RCurl","plyr")

#rentrez is the package in R provides an interface to the NCBI's EUtils API
```


# Data

In order to retreive data based on date range and keywords, a correct search query should be formulated. The package of R named "rentrez" allows R users to pull data from NCBI. 

## PubMed Search

**entrez_db_summary()** shows summary of a certain database, in this case, **PubMed** database is used. 

- Database summary: **PubMed**
```{r, echo=TRUE, message=FALSE, warning=FALSE}
#show the database summary information
entrez_db_summary("pubmed")
```

**entrez_db_searchable()** shows searchable fields under a certain database, users can decide which keywords should be put under which searchable field. 

- List of **PubMed**'s *searchable fields*
```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Searchable fields for database 'pubmed'
entrez_db_searchable("pubmed")
```

- In order to form the PubMed/MEDLINE search for articles between 2000 and 2012 with obesity indicated as the major MeSH descriptor, elements below should be included in the query:
    + *__MAJR__ - MeSH terms of major importance to publication* is used as searchable fields
    + **2000/01/01:2012/12/31[PDAT]** is date of publication/[PDAT]
    + **pubmed** is the database

Below shows the search result, which contains `r obesity_search$retmax` records and a web_history object; 
Here is the summary of search result:
```{r, echo=TRUE, message=FALSE, warning=FALSE}
query <- "obesity[MAJR] AND 2000/01/01:2012/12/31[PDAT]"

obesity_search <- entrez_search(db="pubmed",
                        query,
                        retmode = "xml",
                        use_history = TRUE,
                        retmax=60000)

kable(summary(obesity_search))
```

- A _web histroy_ was returned as well, which NCBI created for users who deals with very large queries. With this _web history_, all records based on the search query were stored on NCBI server waiting for further usage. 
```{r, echo=TRUE, message=FALSE, warning=FALSE}
obesity_search$web_history
```


- **The formulation of the PubMed search is shown below:**
```{r, echo=TRUE, message=FALSE, warning=FALSE}

obesity_search$QueryTranslation

```


In order to make sure this search result match with the number of records on NCBI. The same searching criteria were used on NCBI website manually, and the result is shown below:


![](/Users/ChloeLi/Documents/Dev_dataScienceProjects/BrownUniv/searchResultNCBI.png)
- Sample summary record
```{r}
entrez_summary(db="pubmed",id=obesity_search$ids[1])
```




## Data Retrival

Based on the search query, all records that matched with the criteria were found and all IDs were returned. Those IDs or the web history could be used to fetch all records from NCBI.
However, NCBI only allows users to pull 10,000 records at once. Therefore, a web history needs to be used to save the search result in the server so that all 59,515 records can be pulled from multiple batches. 

- Obtain PubMed/MEDLINE records (in MEDLINE or XML format) for the formulated search using NCBI E-Utilities


```{r, echo=TRUE, message=FALSE, warning=FALSE}
#fetch all records from the formulated search
source('./batchFetch_Fun.R')

#this returns a data frame with extracted information from all records
dt_sum <- batchFetch(obesity_search)


```

- Each record contains two keys: MedlineCitation and PubmedData.  MedlineCitation contains another set of keys including: PMID, MeshHeadingList, Article and so on. In order to extract information from the records, the XML file should be transformed into a list.

The package XML which comes with the installation of rentrez has a function of xmlToList() to obtain information from these XML files. 
```{r}
#transform xml to list
pubmed_list <- XML::xmlToList(fetch_xml)
#------------------------------------------------------------------------------------------------
```











- Create mapping of MeSH descriptors to semantic types using the MeSH Vocabulary file (desc2015.xml) and identify descriptors with type **Disease or Syndrome**
- Link to MeSH Descriptors XML file: _ftp://nlmpubs.nlm.nih.gov/online/mesh/2015/desc2015.xml_
```{r}
#download XML file - 2015 MeSH descriptor
Vocabulary <- XML::xmlParse("ftp://nlmpubs.nlm.nih.gov/online/mesh/2015/desc2015.xml")

#extract SemanticTypeName
#extract_typeONLY <- MeSHdes["//SemanticTypeList/SemanticType/SemanticTypeName"]

#extract SemanticTypeUI and SemanticTypeName
#SemanticTypeUI will map to the 'ST' (semantic Type ID) from the MeSH vocabulary, and SemanticTypeName is the semantic type.
extract_typeID <- Vocabulary["//SemanticTypeList/SemanticType"]

hm <- Vocabulary["//QualifierReferredTo"]


#do not run below
#xml_Semantic <- XML::xmlToList(extract_typeID)

```


- Using a statistical or modeling approach of your choice, identify and rank comorbidities for obesity based on publications that share MeSH descriptors for multiple diseases/syndromes.


```{r, echo=FALSE, message=FALSE, warning=FALSE}
search_year <- function(year, term){
    query <- paste(term, "AND (", year, "[PDAT])")
    entrez_search(db="pubmed", term=query, retmax=0)$count
}

year <- 2000:2012
papers <- sapply(year, search_year, term="obesity", USE.NAMES=FALSE)

plot(year, papers, type='b', main="The Rise of the Obesity")
```

## Methods

#Analysis

## Exploratory Analysis
## Advanced Analysis 


# Results


# Conclusions